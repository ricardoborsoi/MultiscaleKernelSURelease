function [RMSE RE SAM SAMn RCest RE_RC SAM_RC SAMn_RC RMSE_Class RE_Class SAM_Class RE_Class_RC SAM_Class_RC REn] = exploitation_TIP(Y_bloc,MPlus,alpha_est,alpha0,c_Ev,c_Ev0,pRCA,RComp0,K,Label,model)
%%% Performance evaluation using the RMSE, RE and SAM criteria

[L N]   = size(Y_bloc);
[R N]   = size(alpha0);
RMSE    = sqrt(sum((alpha0(:) - alpha_est(:)).^2)/R/N);

% model %1: LMM   2: CDA-NL  3: CDA-ME 

switch model
    case 1  % LMM
        Y_rec    = MPlus*alpha_est;
        RCest    =  zeros(L,N);      % LxN
        
    case 2  %2: RCA-NL
        %%% pRCA  DxN
        M_NL    = [];
        for i=1:R
            for j=i+1:R
                M_NL   = [M_NL  MPlus(:,i).*MPlus(:,j)];
            end
        end
        M_NL   = [sqrt(2)*M_NL MPlus.^2]; % LxD 
    
        RCest  =  (M_NL*pRCA) .*(c_Ev.^2*ones(1,L))';
        Y_rec  = (MPlus*alpha_est) .*(c_Ev*ones(1,L))'  + RCest;
        
    case 3  %3: RCA-ME
        %%% pRCA  LxN
        RCest = pRCA;
        Y_rec = (MPlus*alpha_est) .*(c_Ev*ones(1,L))' + RCest;     
         
end

%%% Reconstruction errors
RE   =  sqrt(sum(sum((Y_bloc - Y_rec).^2))/L/N);
REn  = sqrt((sum((Y_bloc - Y_rec).^2))/L);
for n = 1:N
    SAMn(n)         = acos( (Y_bloc(:,n)' *  Y_rec(:,n))   /norm(Y_bloc(:,n))/norm(Y_rec(:,n)) );
end
SAM  = mean(SAMn);


%%% Residual components
RE_RC   =  sqrt(sum(sum((RComp0 - RCest).^2))/L/N);
for n = 1:N
    SAMn_RC(n)         = acos( (RComp0(:,n)' *  RCest(:,n))   /norm(RComp0(:,n))/norm(RCest(:,n)) );
end
SAM_RC  = mean(SAMn_RC);

%%% Performance in each class
if (K==1)
        RMSE_Class    = RMSE;
        RE_Class      = RE;
        SAM_Class     = SAM;
        RE_Class_RC   = RE_RC;
        SAM_Class_RC  = SAM_RC;
else
    for k=1:K
        ind              = find(Label==k);
        Nc               = length(ind);
        alpha0c          = alpha0(:,ind);
        alpha_estc       = alpha_est(:,ind);
        RMSE_Class(k)    = sqrt(sum((alpha0c(:) - alpha_estc(:)).^2)/R/Nc);
        RE_Class(k)      = sqrt(sum(sum((Y_bloc(:,ind) - Y_rec(:,ind)).^2))/L/Nc);
        SAM_Class(k)     = mean(SAMn(ind));
        RE_Class_RC(k)   = sqrt(sum(sum((RComp0(:,ind) - RCest(:,ind)).^2))/L/Nc);
        SAM_Class_RC(k)  = mean(SAMn_RC(ind));
    end 
end
 
